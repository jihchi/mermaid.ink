// copied from https://github.com/mermaidjs/mermaid-live-editor/blob/master/src/lib/util/serde.ts
const { inflate } = require('pako');
const { toUint8Array, fromBase64 } = require('js-base64');

const deserializeState = (state) => {
  let type, serialized;
  if (state.includes(':')) {
    [type, serialized] = state.split(':');
  } else {
    type = 'base64';
    serialized = state;
  }
  const json = deserializers[type](serialized);
  return JSON.parse(json);
};

const deserializers = {
  pako: (state) => {
    const data = toUint8Array(state);
    return inflate(data, { to: 'string' });
  },
  base64: (state) => {
    return fromBase64(state);
  },
};

module.exports = (base64) => {
  const theme = 'default';
  try {
    return deserializeState(base64);
  } catch (error) {
    // continue previous method.
  }
  const str = Buffer.from(base64, 'base64').toString('utf8');
  let state;
  try {
    state = JSON.parse(str);
    if (state.code === undefined) {
      // not valid json
      state = { code: str, mermaid: { theme } };
    }
  } catch (e) {
    state = { code: str, mermaid: { theme } };
  }
  return state;
};
